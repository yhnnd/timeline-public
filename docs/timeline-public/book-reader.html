<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reader</title>
</head>
<body>
    <style>
        :root {
            --studio-blue: #0675c4;
        }
        .container {
            display: flex;
            justify-content: center;
        }
        pre {
            width: 512px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        pre > .name-link {
            color: var(--studio-blue);
            cursor: pointer;
            position: relative;
            display: inline-block;
        }
        pre > .name-link::before {
            display: none;
            content: attr(data-info);
            color: white;
            background-color: rgba(0, 0, 0, .75);
        }
        pre > .name-link:hover::before {
            display: block;
            position: absolute;
            left: 0;
            top: -18px;
            width: 160px;
        }

        .search-backdrop {
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(244, 244, 244, .8);
            color: black;
            backdrop-filter: blur(2.5px);
            display: none;
        }

        .search-backdrop.on {
            display: flex;
            justify-content: center;
        }

        .search {
            display: flex;
            flex-direction: column;
        }

        .search > .search-bar {
            margin-top: 40px;
            width: 512px;
            position: relative;
        }

        .search > .search-result {
            margin-top: 40px;
            width: 512px;
        }

        .search > .search-bar > .close-button {
            position: absolute;
            right: 0;
            top: 0;
        }
    </style>
    <div class="search-backdrop">
        <div class="search">
            <div class="search-bar">
                <div class="search-keyword"></div>
                <button class="close-button" onclick="closeSearch(this)">close</button>
            </div>
            <div class="search-result"></div>
        </div>
    </div>
    <div class="container">
        <pre></pre>
    </div>
    <script src="../js/vendor/param.js"></script>
    <script src="../js/vendor/names.js"></script>
    <script src="books-index.js"></script>
    <script>
        function ajax (url, callback) {
            const req = new XMLHttpRequest();
            req.addEventListener("load", () => {
                if (callback && typeof callback === "function") {
                    callback(req.responseText);
                } else {
                    console.log("loadData: no callback");
                }
            });
            req.open("GET", url);
            req.send();
        }

        var src = getParameter("src");
        if (src != undefined) {
            ajax (src, function(responseText) {
                console.log("responseText: ", responseText);

                responseText = responseText.replaceAll("<", "&lt;");

                if (window.names != undefined) {
                    window.names = window.names.sort((a, b) => {
                        return b.split(";")[0].length - a.split(";")[0].length;
                    });
                    for (const line of window.names) {
                        const name = line.split(";")[0];
                        let info = line.split(";")[1];
                        if (info == undefined) {
                            info = "点击搜索 " + name;
                        }
                        responseText = responseText.replaceAll(name, "<span class='name-link' data-info='" + info + "' onclick='search(this)'>" + name + "</span>");
                    }
                }

                const pre = document.getElementsByClassName("container")[0].getElementsByTagName("pre")[0];
                pre.innerHTML = responseText;
            });
        }

        function search(element) {
            const keyword = element.innerText;
            const searchWrapper = document.getElementsByClassName("search")[0];
            searchWrapper.parentElement.classList.add("on");
            const keywordWrapper = searchWrapper.getElementsByClassName("search-keyword")[0];
            keywordWrapper.innerText = keyword;

            const resultWrapper = searchWrapper.getElementsByClassName("search-result")[0];
            let items = [];
            for (const book of window.books) {
                if (book != undefined && book["indexList"] != undefined) {
                    for (const url of book["indexList"]) {
                        items.push({
                            "url": url,
                            "text": undefined
                        });
                    }
                }
            }
            let counter = 0;
            for (const i in items) {
                const url = items[i].url;
                ajax (url, function (responseText) {
                    items[i].text = responseText;
                    if (++counter == items.length) {
                        for (const item of items) {
                            if (item.text.includes(keyword)) {
                                let link = document.createElement("div");
                                link.innerHTML = item.url;
                                resultWrapper.appendChild(link);
                            }
                        }
                    } else {
                        resultWrapper.innerText = "searching " + counter + "/" + items.length;
                    }
                });
            }
        }

        function closeSearch() {
            const target = document.getElementsByClassName("search-backdrop")[0];
            target.classList.remove("on");
        }
    </script>
</body>
</html>