<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reader</title>
</head>
<body>
    <style>
        :root {
            --studio-white: #fff;
            --studio-black: #000;
            --studio-gray-0: #f6f7f7;
            --studio-gray-5: #dcdcde;
            --studio-gray-10: #c3c4c7;
            --studio-gray-20: #a7aaad;
            --studio-gray-30: #8c8f94;
            --studio-gray-40: #787c82;
            --studio-gray-50: #646970;
            --studio-gray-60: #50575e;
            --studio-gray-70: #3c434a;
            --studio-gray-80: #2c3338;
            --studio-gray-90: #1d2327;
            --studio-gray-100: #101517;
            --studio-gray: #646970;
            --studio-blue-0: #e9f0f5;
            --studio-blue-5: #bbe0fa;
            --studio-blue-10: #91caf2;
            --studio-blue-20: #68b3e8;
            --studio-blue-30: #399ce3;
            --studio-blue-40: #1689db;
            --studio-blue-50: #0675c4;
            --studio-blue-60: #055d9c;
            --studio-blue-70: #044b7a;
            --studio-blue-80: #02395c;
            --studio-blue-90: #01283d;
            --studio-blue-100: #001621;
            --studio-blue: #0675c4;
            --studio-purple-0: #f2e9ed;
            --studio-purple-5: #ebcee0;
            --studio-purple-10: #e3afd5;
            --studio-purple-20: #d48fc8;
            --studio-purple-30: #c475bd;
            --studio-purple-40: #b35eb1;
            --studio-purple-50: #984a9c;
            --studio-purple-60: #7c3982;
            --studio-purple-70: #662c6e;
            --studio-purple-80: #4d2054;
            --studio-purple-90: #35163b;
            --studio-purple-100: #1e0c21;
            --studio-purple: #984a9c;
            --studio-pink-0: #f5e9ed;
            --studio-pink-5: #f2ceda;
            --studio-pink-10: #f7a8c3;
            --studio-pink-20: #f283aa;
            --studio-pink-30: #eb6594;
            --studio-pink-40: #e34c84;
            --studio-pink-50: #c9356e;
            --studio-pink-60: #ab235a;
            --studio-pink-70: #8c1749;
            --studio-pink-80: #700f3b;
            --studio-pink-90: #4f092a;
            --studio-pink-100: #260415;
            --studio-pink: #c9356e;
            --studio-red-0: #f7ebec;
            --studio-red-5: #facfd2;
            --studio-red-10: #ffabaf;
            --studio-red-20: #ff8085;
            --studio-red-30: #f86368;
            --studio-red-40: #e65054;
            --studio-red-50: #d63638;
            --studio-red-60: #b32d2e;
            --studio-red-70: #8a2424;
            --studio-red-80: #691c1c;
            --studio-red-90: #451313;
            --studio-red-100: #240a0a;
            --studio-red: #d63638;
            --studio-orange-0: #f5ece6;
            --studio-orange-5: #f7dcc6;
            --studio-orange-10: #ffbf86;
            --studio-orange-20: #faa754;
            --studio-orange-30: #e68b28;
            --studio-orange-40: #d67709;
            --studio-orange-50: #b26200;
            --studio-orange-60: #8a4d00;
            --studio-orange-70: #704000;
            --studio-orange-80: #543100;
            --studio-orange-90: #361f00;
            --studio-orange-100: #1f1200;
            --studio-orange: #b26200;
            --studio-yellow-0: #f5f1e1;
            --studio-yellow-5: #f5e6b3;
            --studio-yellow-10: #f2d76b;
            --studio-yellow-20: #f0c930;
            --studio-yellow-30: #deb100;
            --studio-yellow-40: #c08c00;
            --studio-yellow-50: #9d6e00;
            --studio-yellow-60: #7d5600;
            --studio-yellow-70: #674600;
            --studio-yellow-80: #4f3500;
            --studio-yellow-90: #320;
            --studio-yellow-100: #1c1300;
            --studio-yellow: #9d6e00;
            --studio-green-0: #e6f2e8;
            --studio-green-5: #b8e6bf;
            --studio-green-10: #68de86;
            --studio-green-20: #1ed15a;
            --studio-green-30: #00ba37;
            --studio-green-40: #00a32a;
            --studio-green-50: #008a20;
            --studio-green-60: #007017;
            --studio-green-70: #005c12;
            --studio-green-80: #00450c;
            --studio-green-90: #003008;
            --studio-green-100: #001c05;
            --studio-green: #008a20;
            --studio-celadon-0: #e4f2ed;
            --studio-celadon-5: #a7e8d3;
            --studio-celadon-10: #66deb9;
            --studio-celadon-20: #31cc9f;
            --studio-celadon-30: #09b585;
            --studio-celadon-40: #009e73;
            --studio-celadon-50: #008763;
            --studio-celadon-60: #007053;
            --studio-celadon-70: #005c44;
            --studio-celadon-80: #004533;
            --studio-celadon-90: #003024;
            --studio-celadon-100: #001c15;
            --studio-celadon: #008763;
            --studio-wordpress-blue-0: #e6f1f5;
            --studio-wordpress-blue-5: #bedae6;
            --studio-wordpress-blue-10: #98c6d9;
            --studio-wordpress-blue-20: #6ab3d0;
            --studio-wordpress-blue-30: #3895ba;
            --studio-wordpress-blue-40: #187aa2;
            --studio-wordpress-blue-50: #006088;
            --studio-wordpress-blue-60: #004e6e;
            --studio-wordpress-blue-70: #003c56;
            --studio-wordpress-blue-80: #002c40;
            --studio-wordpress-blue-90: #001d2d;
            --studio-wordpress-blue-100: #00101c;
            --studio-wordpress-blue: #006088;
            --studio-simplenote-blue-0: #e9ecf5;
            --studio-simplenote-blue-5: #ced9f2;
            --studio-simplenote-blue-10: #abc1f5;
            --studio-simplenote-blue-20: #84a4f0;
            --studio-simplenote-blue-30: #618df2;
            --studio-simplenote-blue-40: #4678eb;
            --studio-simplenote-blue-50: #3361cc;
            --studio-simplenote-blue-60: #1d4fc4;
            --studio-simplenote-blue-70: #113ead;
            --studio-simplenote-blue-80: #0d2f85;
            --studio-simplenote-blue-90: #09205c;
            --studio-simplenote-blue-100: #05102e;
            --studio-simplenote-blue: #3361cc;
            --studio-woocommerce-purple-0: #f7edf7;
            --studio-woocommerce-purple-5: #e5cfe8;
            --studio-woocommerce-purple-10: #d6b4e0;
            --studio-woocommerce-purple-20: #c792e0;
            --studio-woocommerce-purple-30: #af7dd1;
            --studio-woocommerce-purple-40: #9a69c7;
            --studio-woocommerce-purple-50: #7f54b3;
            --studio-woocommerce-purple-60: #674399;
            --studio-woocommerce-purple-70: #533582;
            --studio-woocommerce-purple-80: #3c2861;
            --studio-woocommerce-purple-90: #271b3d;
            --studio-woocommerce-purple-100: #140e1f;
            --studio-woocommerce-purple: #7f54b3;
            --studio-jetpack-green-0: #f0f2eb;
            --studio-jetpack-green-5: #d0e6b8;
            --studio-jetpack-green-10: #9dd977;
            --studio-jetpack-green-20: #64ca43;
            --studio-jetpack-green-30: #2fb41f;
            --studio-jetpack-green-40: #069e08;
            --studio-jetpack-green-50: #008710;
            --studio-jetpack-green-60: #007117;
            --studio-jetpack-green-70: #005b18;
            --studio-jetpack-green-80: #004515;
            --studio-jetpack-green-90: #003010;
            --studio-jetpack-green-100: #001c09;
            --studio-jetpack-green: #069e08;
        }
        .container {
            display: flex;
            justify-content: center;
        }
        pre {
            width: 512px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        pre > .highlight-red {
            color: var(--studio-red);
            cursor: pointer;
            display: inline-block;
        }
        pre > .censored {
            color: var(--studio-black);
            background-color: var(--studio-black);
            cursor: pointer;
            display: inline-block;
        }
        pre > .name-link {
            color: var(--studio-blue);
            cursor: pointer;
            position: relative;
            display: inline-block;
        }
        pre > .name-link::before {
            display: none;
            content: attr(data-info);
            color: white;
            background-color: rgba(0, 0, 0, .75);
        }
        pre > .name-link:hover::before {
            display: block;
            position: absolute;
            left: 0;
            top: -18px;
            width: 160px;
        }

        .search-backdrop {
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(244, 244, 244, .8);
            color: black;
            backdrop-filter: blur(2.5px);
            display: none;
        }

        .search-backdrop.on {
            display: flex;
            justify-content: center;
            overflow: scroll;
        }

        .search {
            display: flex;
            flex-direction: column;
        }

        .search > .search-bar {
            margin-top: 40px;
            width: 512px;
            position: relative;
        }

        .search > .search-bar > .close-button {
            position: absolute;
            right: 0;
            top: 0;
        }

        .search > .search-result {
            margin-top: 40px;
            width: 512px;
        }

        .search > .search-result > .link {
            position: relative;
            display: block;
        }

        .search > .search-result > .link::before {
            content: attr(data-text);
            overflow: hidden;
            text-overflow: ellipsis;
            display: none;
        }

        .search > .search-result > .link:hover::before {
            display: block;
            width: 200px;
            height: 200px;
            position: absolute;
            left: -200px;
            top: -100px;
            background: rgba(116, 255, 167, 0.3);
            color: black;
        }

        .modal-open {
            overflow: hidden;
        }
    </style>
    <div class="search-backdrop">
        <div class="search">
            <div class="search-bar">
                <div class="search-keyword"></div>
                <button class="close-button" onclick="closeSearch(this)">close</button>
            </div>
            <div class="search-result"></div>
        </div>
    </div>
    <div class="container">
        <pre></pre>
    </div>
    <script src="../js/vendor/param.js"></script>
    <script src="../js/timeline/names.js"></script>
    <script src="../js/timeline/books-index.js"></script>
    <script>
        const symbols = ['⓪','①','②','③','④','⑤','⑥','⑦','⑧','⑨','⑩','⑪','⑫','⑬','⑭','⑮','⑯','⑰','⑱','⑲','⑳','㉑','㉒','㉓','㉔','㉕','㉖','㉗','㉘','㉙','㉚','㉛','㉜','㉝','㉞','㉟','㊱','㊲','㊳','㊴','㊵','㊶','㊷','㊸','㊹','㊺','㊻','㊼','㊽','㊾','㊿'];

        const censored = ["中國","中共國","共匪國","大陸","美國","淪陷區","匪佔區","共產黨","中共","共匪","共黨","赤黨","赤匪","匪黨","匪諜","毛賊"];

        function ajax (url, callback) {
            const req = new XMLHttpRequest();
            req.addEventListener("load", () => {
                if (callback && typeof callback === "function") {
                    callback(req.responseText);
                } else {
                    console.log("loadData: no callback");
                }
            });
            req.open("GET", url);
            req.send();
        }

        var src = getParameter("src");
        if (src != undefined) {
            ajax (src, function(responseText) {
                console.log("responseText: ", responseText);

                responseText = responseText.replaceAll("<", "&lt;");

                // highlight all the symbols like ①, ②, ③.
                for (const symbol of symbols) {
                    const replacement = "<span class='highlight-red'>" + symbol + "</span>";
                    responseText = responseText.replaceAll(symbol, replacement);
                }

                // censor all the censored words
                for (const item of censored) {
                    const replacement = "<span class='censored'>" + item + "</span>";
                    responseText = responseText.replaceAll(item, replacement);
                }

                if (window.peoplesNames != undefined) {
                    window.peoplesNames = window.peoplesNames.sort((a, b) => {
                        return b[0].split(";")[0].length - a[0].split(";")[0].length;
                    });
                    for (const i in window.peoplesNames) {
                        const items = window.peoplesNames[i];
                        for (const item of items) {
                            const name = item.split(";")[0];
                            let info = item.split(";")[1];
                            if (info == undefined) {
                                info = "点击搜索";
                            }
                            let nameLink = document.createElement("div");
                            nameLink.classList.add("name-link");
                            nameLink.setAttribute("data-info", info);
                            nameLink.setAttribute("data-name-index", i);
                            nameLink.setAttribute("onclick", "search(this)");
                            nameLink.innerHTML = "<span>" + name.split("").join("</span><span>") + "</span>";
                            responseText = responseText.replaceAll(name, nameLink.outerHTML);
                        }
                    }
                }

                const pre = document.getElementsByClassName("container")[0].getElementsByTagName("pre")[0];
                pre.innerHTML = responseText;
            });
        }

        function search(element) {
            const nameIndex = element.getAttribute("data-name-index");
            if (nameIndex == undefined) {
                return false;
            }
            const keywords = window.peoplesNames[nameIndex];

            document.body.classList.add("modal-open");
            // const keyword = element.innerText;
            const searchWrapper = document.getElementsByClassName("search")[0];
            searchWrapper.parentElement.classList.add("on");
            const keywordWrapper = searchWrapper.getElementsByClassName("search-keyword")[0];
            keywordWrapper.innerText = keywords.join(",");

            const resultWrapper = searchWrapper.getElementsByClassName("search-result")[0];
            let items = [];
            for (const book of window.books) {
                if (book != undefined && book["indexList"] != undefined) {
                    for (const url of book["indexList"]) {
                        items.push({
                            "url": url,
                            "text": undefined
                        });
                    }
                }
            }
            let counter = 0;
            for (const i in items) {
                const url = items[i].url;
                ajax (url, function (responseText) {
                    items[i].text = responseText;
                    if (++counter == items.length) {
                        resultWrapper.innerHTML = "";
                        for (const item of items) {
                            let times = 0;
                            let isMatched = false;
                            for (const keyword of keywords) {
                                if (item.text.includes(keyword)) {
                                    isMatched = true;
                                    times += item.text.split(keyword).length - 1;
                                }
                            }
                            if (isMatched == true) {
                                let link = document.createElement("div");
                                link.classList.add("link");
                                link.setAttribute("data-text", item.text);
                                link.setAttribute("data-times", times);
                                link.innerHTML = "<a target='_blank' href='book-reader.html?src=" + item.url + "'>" + item.url + "</a>";
                                resultWrapper.appendChild(link);
                            }
                        }
                    } else {
                        resultWrapper.innerText = "searching " + counter + "/" + items.length;
                    }
                });
            }
        }

        function closeSearch() {
            const target = document.getElementsByClassName("search-backdrop")[0];
            target.classList.remove("on");
            document.body.classList.remove("modal-open");
        }
    </script>
</body>
</html>